# Technical Design Document (TDD) — SHARDS v0.3.0 (Integrated Vision)

## 1. Архитектура игровых объектов (Component-Based)
Логика делится на независимые узлы (Nodes), взаимодействующие через сигналы.

### Основные компоненты:
*   **StatsComponent (Node)**: Хранит `CurrentHP` и `MaxHP`. Метод `take_damage(amount, type)`. Игнорирует отрицательный урон. При HP <= 0 испускает сигнал `died` один раз.
*   **EnvHazardComponent (Node)**: 
    *   Состояние [Passive]: Ждет сигнала смерти от своего StatsComponent.
    *   Состояние [Active]: Включает Area3D (слой Hazards) и запускает таймер жизни зоны.
    *   Завершение: По таймеру отключает коллизию и удаляет объект.
*   **MovementController (Node3D)**: Управляет CharacterBody3D. В состоянии EFFECTED (тип ELEC) снижает скорость до 0.5.

## 2. Глобальные системы (Core)
*   **EntropyManager (Singleton)**: Глобальный "источник истины".
    *   Уровень Энтропии (0–5): Растет при смерти объектов с тегом `Boss`.
    *   Событийная модель: Рассылает сигнал `entropy_leveled_up(new_level)`.
    *   Реактивность: Окружение (кусты, вода) подписано на сигнал и активирует опасные зоны (например, яд при уровне 2+).

## 3. Конфигурация коллизий (Collision Layers)
Распределение слоев и масок для физического взаимодействия:

*   **Слой 1 (World)**: Статичная геометрия. Никого не ищет.
*   **Слой 2 (Player)**: Маска 1 (пол/стены) и 5 (зоны урона).
*   **Слой 3 (Enemies)**: Маска 1 (пол/стены) и 5 (зоны урона).
*   **Слой 4 (Interactables)**: Объекты вроде бочек. Маска 1 и 5.
*   **Слой 5 (Hazards)**: Маска 2 (игрок), 3 (враги) и 4 (другие бочки).

## 4. Алгоритм нанесения урона (Damage Flow)

### 4.1. Стандартный урон (Пули/Рукопашка)
1. CombatHandler находит объект через RayCast3D (слои 2, 3, 4).
2. Проверяет наличие StatsComponent.
3. Вызывает метод `take_damage(amount, type)`.

### 4.2. Урон от окружения (Hazards)
1. Объект (слои 2, 3, 4) пересекает Area3D (слой 5).
2. EnvHazardComponent отправляет сигнал `Hit(type, dps, duration)`.
3. Цепная реакция: Бочка (слой 4) получает FIRE-урон -> взрывается -> создает новую зону FIRE.

## 5. Машина состояний (State Machine)
*   **IDLE / MOVE / ATTACK**: Базовые состояния.
*   **EFFECTED**: Включается при получении сигналов от зон урона.
    *   FIRE: Визуальный эффект горения + периодический урон.
    *   ELEC: Стан/замедление на время `duration`.
    *   RAD: Рост уровня радиации в HUD.

## 6. Искусственный интеллект (Enemy AI)
*   **MVP**: Использует NavigationAgent3D. Игнорирует зоны Hazards при поиске пути, получает урон при входе.
*   **Backlog**: Динамический обход опасных зон — реализация в v0.4+.

## 7. Управление данными (Resources)
*   `HazardData.tres`: Настройки DPS, типа урона и времени жизни зоны.
*   `EntropyData.tres`: Условия мутации мира (связь уровня энтропии с активацией зон).
