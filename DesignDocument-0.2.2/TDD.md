# Technical Design Document (TDD) — SHARDS v0.3 (Integrated Vision)

## 1. Архитектура игровых объектов (Компонентный подход)
Вместо одного перегруженного скрипта логика делится на независимые узлы (Nodes). Это позволяет
переиспользовать код для игрока и врагов.

### Основные компоненты:
* **StatsComponent (Node)**: Отвечает за выживание. Хранит текущее/максимальное HP. Принимает урон через
  функцию `take_damage` и выдает сигнал `died` при обнулении.
* **CombatHandler (Node3D)**: Узел управления оружием. Содержит ссылки на `RayCast3D` (пистолет) и `Area3D`
  (копье). Проверяет слои коллизий перед нанесением урона.
* **MovementController (Node3D)**: Обрабатывает ввод и перемещает `CharacterBody3D`. Инкапсулирует физику
  движения.
* **EnvHazardComponent (Node):** **[НОВЫЙ КОМПОНЕНТ]** Устанавливается на объекты окружения (бочки, лужи, щитки). Определяет тип угрозы (`RAD`, `FIRE`, `ELEC`) и управляет активацией/деактивацией своей `Area3D` при получении урона или взаимодействии с другими зонами.

## 2. Система взаимодействия (Signals & Groups)
Для гибкости кода используем систему событий вместо прямого обращения к объектам.
* **Сигналы (Signals)**: Компоненты сообщают о событиях (например, `health_changed` для обновления HUD). Это
  позволяет менять интерфейс, не трогая логику игрока.
* **Группы (Groups)**: Объекты делятся на группы "Enemies", "Player" и **"Hazards"**. Группа "Hazards" упрощает обработку пересечений с опасными зонами.

## 3. Машина состояний (State Machine)
Логика игрока и ИИ разделена на четкие состояния для исключения багов управления:
* **IDLE**: Состояние покоя. Регенерация стамины на максимуме.
* **MOVE**: Перемещение. Ввод активен, регенерация замедлена.
* **ATTACK**: Состояние атаки. Ввод движения может быть заблокирован (зависит от анимации).
* **DEATH**: Отключение коллизий, остановка всех процессов, запуск таймера респауна.
* **EFFECTED**: **[НОВОЕ СОСТОЯНИЕ]** Активируется при попадании в опасную зону (`Area3D`). Блокирует спринт, может замедлять движение (например, при эффекте `ELEC`).

## 4. Управление данными (Resources)
Все балансовые переменные выносятся в отдельные файлы `.tres` (Resources). Это позволяет менять урон,
скорость и HP в инспекторе без правки скриптов.
* **HazardData (.tres):** **[НОВЫЙ ТИП РЕСУРСА]** Хранит настройки урона в секунду (DPS), длительность эффектов (DoT), тип урона (`RAD`, `FIRE`, `ELEC`) и **MAX_DPS_CAP** (максимальный урон, который может получить игрок суммарно от всех зон).

## 5. Техническая реализация ИИ (Enemy AI)
* **Навигация**: `NavigationAgent3D` обновляет целевой путь по таймеру (раз в 0.3–0.5 сек) для экономии
  ресурсов процессора. **AI теперь умеет избегать Зоны Угрозы (Hazards) при расчете пути.**
* **Проверка видимости (LOS)**: Перед выстрелом ИИ проверяет игрока через `RayCast3D`. Если луч пересекает
  слой "World" (стены) или **"Hazards" (например, облако радиации)**, выстрел отменяется.

## 6. Конфигурация коллизий (Collision Layers)
Распределение слоев для корректной работы физики:
* **Слой 1 (World)**: Статичная геометрия уровня (пол, стены).
* **Слой 2 (Player)**: Физическое тело игрока.
* **Слой 3 (Enemies)**: Физические тела врагов и мишеней.
* **Слой 4 (Interact)**: Объекты взаимодействия (сундуки).
* **Слой 5 (Hazards):** **[НОВЫЙ СЛОЙ]** Используется для `Area3D` с опасными зонами (огонь, ток, радиация).

## 7. Структура проекта (File Structure)
Организация файлов по функциональным папкам для удобства масштабирования.
* **assets/** — Внешние ресурсы (модели .glb, текстуры, звуки, particle systems).
* **src/core/** — Глобальные системы и синглтоны (GameMaster, GlobalSignalBus, **EntropyManager**).
* **src/entities/** — Основные игровые объекты:
 * `player/` — Сцена игрока, скрипты управления и визуализация.
 * `enemies/` — Сцены врагов, логика ИИ.
 * `world_hazards/` — **[НОВАЯ ПАПКА]** Префабы бочек, луж, щитков с `EnvHazardComponent`.
* **src/components/** — Переиспользуемые узлы (HealthComponent, StaminaComponent, **EnvHazardComponent**).
* **src/ui/** — Элементы интерфейса (HUD, меню паузы).
* **data/resources/** — Файлы данных `.tres` с настройками баланса (урон, скорость, **HazardData**).
* **scenes/levels/** — Файлы игровых локаций и тестовых арен.

## 8. Алгоритм нанесения урона (Damage Flow)
Чтобы код был гибким, мы не используем прямые ссылки. Алгоритм взаимодействия при ударе/выстреле:

### 8.1. Стандартный урон (Пули/Рукопашка)
1. **Инициация**: `CombatHandler` (у игрока) активирует `RayCast3D` или `Area3D`.
2. **Обнаружение**: При пересечении со слоем "Enemies" или "Player", получаем ссылку на объект `collider`.
3. **Проверка**: `if collider.has_node("HealthComponent"):`
4. **Передача**: Вызываем метод `collider.get_node("HealthComponent").take_damage(amount)`.
5. **Реакция**: `HealthComponent` обрабатывает HP и сигналы `health_changed` / `died`.

### 8.2. Урон от окружения (Химия/Энтропия)
1. **Обнаружение**: `CharacterBody3D` игрока/врага пересекает `Area3D` из слоя "Hazards".
2. **Сигнал**: `EnvHazardComponent` отправляет сигнал `apply_hazard_effect(type, dps_amount, duration)` на `HealthComponent` цели.
3. **Обработка в HealthComponent**:
   * Компонент суммирует входящий DPS от всех активных зон.
   * Применяет `MAX_DPS_CAP`: `actual_dps = min(total_dps_sum, MAX_ALLOWED_DPS_CAP)`.
   * Начинает тикать таймер урона (с учетом `delta`), нанося `actual_dps` в секунду.
   * Активирует состояние `EFFECTED` в `MovementController` для визуального фидбека (шейдеры, эффекты на экране) и изменения логики движения.

## 9. Цикл ИИ (Simple AI Behavior) - [Обновлено]
Логика врага-кубика в MVP строится на итеративном обновлении:
1. **Update Timer**: Раз в 0.5 сек `NavigationAgent3D` обновляет `target_position` (координаты игрока).
2. **Movement**: В каждом `_physics_process` враг берет `get_next_path_position()` и двигается к ней через `velocity`. **Если путь лежит через активную зону (Hazards), ИИ пытается пересчитать маршрут в обход.**
3. **Vision Check**: Перед выстрелом враг пускает свой `RayCast3D` в сторону игрока:
 * Если первый коллидер на пути — "Player", враг стреляет.
 * Если первый коллидер — "World" (стена) или **"Hazards" (преграда/дым/облако)**, враг продолжает сближение.
4. **Attack Cooldown**: После выстрела запускается `Timer`, блокирующий стрельбу на N секунд.
